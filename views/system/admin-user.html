<style>
  .multipleSelect button{
    height:34px;
  }
  .multipleSelect button span,.multipleSelect button div{
    margin-top:4px;
  }
  .multipleSelect div ul li{
    text-align: left;
  }
  .droptree{
    width:100%;
  }
</style>

<div class="am-cf am-padding am-padding-bottom-0">
  <div class="am-fl am-cf">
    <strong class="am-text-primary am-text-lg">系统管理</strong> /
    <small>用户管理</small>
  </div>
</div>

<!--新增、修改 模态框-->
<div class="am-modal am-modal-prompt" tabindex="-1" id="my-prompt">
  <div class="am-modal-dialog">
    <div class="am-modal-hd">用户配置</div>
    <div class="am-modal-bd" style="max-height: 440px;overflow:auto;overflow-x:hidden;">
      <div class="am-form-group">
        <div class="am-form am-form-horizontal" id="formSubmitData">
          <input type="hidden" id="id" name="id"/>
          <input type="hidden" id="password" name="password"/>
          <div class="am-form-group">
            <label for="username" class="am-u-sm-12 am-u-md-3 am-form-label">用户名称</label>
            <div class="am-u-sm-12 am-u-md-9">
              <input type="text" id="username" name="username" placeholder="输入用户名" class="am-form-field am-radius">
            </div>
          </div>
          <div class="am-form-group">
            <label for="nick" class="am-u-sm-12 am-u-md-3 am-form-label">昵称</label>
            <div class="am-u-sm-12 am-u-md-9">
              <input type="text" id="nick" name="nick" placeholder="输入昵称" class="am-form-field am-radius">
            </div>
          </div>
          <div class="am-form-group">
            <label for="phone" class="am-u-sm-12 am-u-md-3 am-form-label">电话号</label>
            <div class="am-u-sm-12 am-u-md-9">
              <input type="text" id="phone" name="phone" placeholder="输入电话号" class="am-form-field am-radius">
            </div>
          </div>
          <div class="am-form-group">
            <label for="photo" class="am-u-sm-12 am-u-md-3 am-form-label">头像</label>
            <div class="am-u-sm-12 am-u-md-9">
              <input type="text" id="photo" name="photo" placeholder="选择头像" class="am-form-field am-radius">
            </div>
          </div>
          <div class="am-form-group">
            <label for="email" class="am-u-sm-12 am-u-md-3 am-form-label">邮箱</label>
            <div class="am-u-sm-12 am-u-md-9">
              <input type="text" id="email" name="email" placeholder="输入邮箱" class="am-form-field am-radius">
            </div>
          </div>
          <div class="am-form-group">
            <label for="weixin" class="am-u-sm-12 am-u-md-3 am-form-label">微信号</label>
            <div class="am-u-sm-12 am-u-md-9">
              <input type="text" id="weixin" name="weixin" placeholder="输入微信号" class="am-form-field am-radius">
            </div>
          </div>
          <div class="am-form-group">
            <label for="qq" class="am-u-sm-12 am-u-md-3 am-form-label">qq</label>
            <div class="am-u-sm-12 am-u-md-9">
              <input type="text" id="qq" name="qq" placeholder="输入qq" class="am-form-field am-radius">
            </div>
          </div>
          <div class="am-form-group">
            <label class="am-u-sm-12 am-u-md-3 am-form-label">所属组织</label>
            <div class="am-u-sm-12 am-u-md-9">
              <div id="doc-dropdown-org" class="am-dropdown droptree am-u-sm-12 am-u-md-9" data-am-dropdown>
                <input id="org_name" type="text" class="am-form-field am-radius am-dropdown-toggle" placeholder="请选择组织" width="100%" readonly="readonly"/>
                <input id="org_id" type="hidden" />
                <div class="am-dropdown-content"  style="height: 220px;width: 250px;overflow:auto;overflow-x:hidden;">
                  <ul id="orgShowList" class="ztree"></ul>
                </div>
              </div>
            </div>
          </div>
          <div class="am-form-group">
            <label class="am-u-sm-12 am-u-md-3 am-form-label">角色</label>
            <div class="am-u-sm-12 am-u-md-9">
               <select id="role" class="multipleSelect" multiple="multiple"></select>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="am-modal-footer">
      <span class="am-modal-btn" data-am-modal-cancel>取消</span>
      <span class="am-modal-btn" data-am-modal-confirm>提交</span>
    </div>
  </div>
</div>

<!--删除模态框-->
<div class="am-modal am-modal-confirm" tabindex="-1" id="my-confirm">
  <div class="am-modal-dialog">
    <div class="am-modal-hd">用户删除</div>
    <div class="am-modal-bd">
      你，确定要删除这条记录吗？
    </div>
    <div class="am-modal-footer">
      <span class="am-modal-btn" data-am-modal-cancel>取消</span>
      <span class="am-modal-btn" data-am-modal-confirm>确定</span>
    </div>
  </div>
</div>
<hr>

<div class="am-g">
  <div class="am-u-md-12">
    <!-- Example Classes -->
    <div id="toolbar" class="form-inline am-u-sm-12 am-u-md-12 am-u-lg-12">
      <button id="addrow" data-am-modal="{target: '#my-popup'}" class="form-control am-btn am-btn-success">
        <i class="am-icon-plus"></i>新增
      </button>
      <button id="delrow" class="form-control am-btn am-btn-danger">
        <i class="am-icon-trash-o"></i>删除
      </button>
      <input id="name" name="name" class="form-control" placeholder="请输入用户名称"/>
      <select id="searchRole" class="multipleSelect" multiple="multiple" style="width:167px;height:34px"></select>
      <div id="doc-dropdown" class="am-dropdown" data-am-dropdown>
        <input id="userOrg_name" class="form-control am-dropdown-toggle" placeholder="请选择组织" readonly="readonly"/>
        <input id="userOrg_id" type="hidden" />
        <div class="am-dropdown-content" style="max-height: 220px;width: 250px;overflow:auto;overflow-x:hidden;">
          <ul id="orgSearchList" class="ztree"></ul>
        </div>
      </div>
      <button class="form-control" onclick="query()">查询</button>
      <button class="form-control" onclick="reset()">重置</button>
    </div>
    <table id="table"></table>
  </div>
</div>

<script>
  var delIds = "",commonUrl="/user";
  window.events = {
    'click #edit': function (event, value, row, index) {
      openModal();
      $.each(row,function(i,e){
        var $obj = $("#"+i);
        if($obj.attr("name")=="rightCheckbox"){
          if(e==1){
            $("#"+i).prop("checked",true);
          }else{
            $("#"+i).prop("checked",false);
          }
        }else{
          if($obj.attr("id")=="menu_id"){
            var eArr = e.split(",",-1);
            for(var ev in eArr){
              var node = showTreeObj.getNodeByParam("id",eArr[ev], null);
              if(!node.isParent){
                showTreeObj.checkNode(node, true, true);
              }
            }
          }
          $("#"+i).val(e);
        }
      });
    },
    'click #del': function (e, value, row, index) {
      delIds = value;
      deleteData();
    }
  };

  // 下拉zTree组件组织
  var showSetting = {
    view: {
      selectedMulti: false
    },
    check: {
      enable: false
    },
    data: {
      simpleData: {
        enable: true
      }
    },
    edit: {
      enable: false
    },
    callback:{
      onClick:onShowClick
    }
  },searchSetting = {
    view: {
      selectedMulti: false
    },
    check: {
      enable: false
    },
    data: {
      simpleData: {
        enable: true
      }
    },
    edit: {
      enable: false
    },
    callback:{
      onClick:onSearchClick
    }
  };

  var deleteId="",rightCheckbox="",result = {},showTreeObj,searchTreeObj;
  result.columns = [];
  result.columns.push({field: "选择",checkbox: true,title:"选择",align:"center",valign:"middle"}),
  result.columns.push({field: 'id',title: '操作',align: 'center',valign: 'middle',width: '140px',events: events,formatter: formatter});
  result.columns.push({field: "序号",title:"序号",align:"center",valign:"middle",formatter: function (value, row, index) {return index+1;}});
  result.columns.push({field: 'username',title: "用户名",align: 'center',valign: 'middle',rowspan: 1,colspan: 1});
  result.columns.push({field: 'nick',title: "昵称",align: 'center',valign: 'middle',rowspan: 1,colspan: 1});
  result.columns.push({field: 'photo',title: "头像",align: 'center',valign: 'middle',rowspan: 1,colspan: 1,visible:false});
  result.columns.push({field: 'email',title: "电子邮件",align: 'center',valign: 'middle',rowspan: 1,colspan: 1});
  result.columns.push({field: 'qq',title: "qq",align: 'center',valign: 'middle',rowspan: 1,colspan: 1,visible:false});
  result.columns.push({field: 'weixin',title: "微信",align: 'center',valign: 'middle',rowspan: 1,colspan: 1,visible:false});
  result.columns.push({field: 'org_name',title: "所属组织",align: 'center',valign: 'middle',rowspan: 1,colspan: 1});
  result.columns.push({field: 'role_name',title: "拥有角色",align: 'center',valign: 'middle',rowspan: 1,colspan: 1});


  function query(){
    initBootstrapTable(result,commonUrl+"/list");
  }
  //组织bootstrapTable
  function initBootstrapTable(result,url){

    //bootstrapTable调用
    $('#table').bootstrapTable('destroy').bootstrapTable({
      method:"post",
      url: url,
      cache: false, //是否使用缓存，默认为true，所以一般情况下需要设置一下这个属性（*）
      striped: true, //设置为 true 会有隔行变色效果
      pagination: true, //启动分页
      pageSize: 10, //每页显示的记录数
      pageNumber:1, //当前第几页
      pageList: [5,10, 20, 30, 50, 100,"ALL"], //记录数可选列表
      search: false, //是否启用查询
      showColumns: true, //显示下拉框勾选要显示的列
      minimumCountColumns:2,//过滤列时最少可以省下多少列
      showRefresh: true,//显示刷新按钮
      sidePagination:"server",//服务器端分页
      height: "380px",//table高度
      clickToSelect:false,//点击行内数据 进行checkbox选中
      sortable: true,//排序
      toolbar:"#toolbar",//查询工具 自定义空间
      paginationPreText: "上一页",//上一页下一页图标 可自定义
      paginationNextText: "下一页",//上一页下一页图标 可自定义
      maintainSelected:true,
      sortable:true,
      queryParams:function(params){//查询参数
        $("#toolbar :input").not("button").each(function(i,e){
          var $obj = $(e);
          var vid = $obj.attr("id");
          if(vid!=undefined){
            if(vid=="searchRole"){
              if($("#searchRole").val()!=null){
                params[vid] = $("#searchRole").multipleSelect("getSelects").join(",");
                params[vid+"Name"] = $("#searchRole").multipleSelect("getSelects","text").join(",");
              }
            }else{
              params[vid]=$obj.val();
            }
          }
        });
        return params;
      },
      showPaginationSwitch:false,//显示分页标签控制按钮
      showToggle:true,//选择性显示列 如果不想看到的列可以在此过滤掉
      cardView:false,//已卡片样式展示列表
      detailView:true,//详细列表显示 前面添加一个“ + ”点击可以看到详细列表
      detailFormatter:function(index,row){//详细信息拦截处理
        var result = "";
        for(var obj in row){
          if(row[obj]!=undefined) {
            result += "<div class='col-md-3'>"+obj + ":" + row[obj] + "\n</div>";
          }else{
            result += "<div class='col-md-3'>"+obj + ":\n</div>"
          }
        }
        return result;
      },
      showExport:true,//table导出   server 服务器分页只能导出当前页  client分页 可以按规则导出
      exportDataType: "selected",//导出文件 basic 是本页信息、all是所有信息、selected被选中信息
      columns: result.columns
    });

  }

  /** bootstrap-table 操作 formatter */
  function formatter(value, row, index) {
    return [
      '<div class="am-btn-group-xs">'+
      '<button id="edit" type="button" data-am-modal="{target: \'#my-popup\'}" ' +
      'class="am-btn-xs am-btn-warning am-round"><i class="am-icon-pencil"></i>修改</button>'+
      '<button id="del" type="button" ' +
      'class="am-btn-xs am-btn-danger am-round"><i class="am-icon-trash-o"></i>删除</button>'+
      '</div>'
    ].join('');
  }

  /**新增页面打开*/
  $("#addrow").on("click",function() {
    openModal();
  });
  /**删除用户数据*/
  $("#delrow").on("click",function() {
    var value = "";
    var checkedData = $('#table').bootstrapTable('getAllSelections');
    for(var ind in checkedData){
      value += checkedData[ind].id+"','";
    }
    value = value.substring(0,value.length-3);
    delIds = value;
    deleteData();
  });
  /** 打开数据窗口模型 */
  function openModal(){
    $("#formSubmitData :input").not("[type='checkbox']").val("");
    showTreeObj.checkAllNodes(false);
    $("#role").multipleSelect("uncheckAll");
    $('#my-prompt').modal({
      relatedTarget: this,
      onConfirm: function(e) {
        var data = {};
        $("#formSubmitData :input").each(function(i,e){
          var $obj = $(e);
          var vid = $obj.attr("id");
          if(vid!=undefined){
            if(vid=="role"){
              data[vid] = $("#"+vid).multipleSelect("getSelects").join(",");
              data[vid+"_name"] = $("#"+vid).multipleSelect("getSelects","text").join(",");
            }else{
              data[$obj.attr("id")]=$obj.val();
            }
          }
        });
        $.post(commonUrl+"/save",data,function(ret){
          if(ret.status=="SUCCEED"){
            cheers.success({
              title: '提示',
              message: ret.msg,
              alert: ret.msg
            });
          }else{
            cheers.error({
              title: '错误',
              message: ret.msg,
              alert: ret.msg
            });
          }
          initBootstrapTable(result,commonUrl+"/list");
        });
      },
      onCancel: function(e) {
      }
    });
  }

  /** 删除数据窗口展示 */
  function deleteData(){
    $('#my-confirm').modal({
      relatedTarget: this,
      onConfirm: function(options) {
        var data={};
        data.id = delIds;
        $.post(commonUrl+"/del", data, function (ret) {
          if(ret.status=="SUCCEED"){
            cheers.success({
              title: '提示',
              message: ret.msg,
              alert: ret.msg
            });
          }else{
            cheers.error({
              title: '错误',
              message: ret.msg,
              alert: ret.msg
            });
          }
          initBootstrapTable(result,commonUrl+"/list");
        });
      },
      onCancel: function() {
      }
    });
  }


  /**点击树插件的枝叶*/
  function onShowClick(event, treeId, treeNode){
      var id = treeNode.id;
      var name = treeNode.name;
      $("#org_id").val(id);
      $("#org_name").val(name);
      $("#org_name").attr("title",name);
  }

  /**点击树插件的枝叶*/
  function onSearchClick(event, treeId, treeNode){
    var id = treeNode.id;
    var name = treeNode.name;
    $("#userOrg_id").val(id);
    $("#userOrg_name").val(name);
    $("#userOrg_name").attr("title",name);
  }

  /**
   * 树形菜单 数据组织
   */
  function buildDomTree() {
    var treeData = {},
            treeDataArr = [];
    $.ajax({url:"/org/list",data:{},async:false,type:"post",dataType:"json",
      success:function(data) {
        treeData.id = "0";
        treeData.pId = "";
        treeData.text = "菜单配置";
        treeData.name = "菜单配置";
        treeData.pName = "";
        treeDataArr.push(treeData);
        for(var ind in data){
          var tmpData = {};
          tmpData.id = data[ind].id;
          tmpData.pId = data[ind].pid;
          tmpData.name = data[ind].name;
          tmpData.pname = data[ind].pname;
          treeDataArr.push(tmpData);
        }
      }
    });
    return treeDataArr;
  }

  /** 初始化下拉多选组件 */
  function initMultiSelect(){
    var data={};
    $.ajax({
      url:"/role/slist",
      data:data,
      type:"post",
      dataType:"json",
      success:function(ret){
        if(ret.status=="SUCCEED"){
          var msg = ret.msg;
          for(var m in msg){
            $("#searchRole,#role").append("<option value='"+msg[m].id+"'>"+msg[m].name+"</option>");
          }
        }
        $(".multipleSelect").multipleSelect({
          placeholder: "选择权限信息",
          selectAllText:"全选",
          allSelected:"全部",
          filter: true
        });
      }
    });
  }

  /**重置查询*/
  function reset(){
    $('#toolbar :input').val('');
    searchTreeObj.checkAllNodes(false);
    $("#searchRole").multipleSelect("uncheckAll");
    query();
  }
  $(function () {
    //组织bootstraptable
    initBootstrapTable(result,commonUrl+"/list");
    //初始化下拉树
    $('#doc-dropdown').dropdown({justify: '#doc-dropdown'});
    $('#doc-dropdown-org').dropdown({justify: '#doc-dropdown-org'});
    var treeData = buildDomTree();
    //初始化ztree
    showTreeObj =  $.fn.zTree.init($("#orgShowList"), showSetting,treeData);
    searchTreeObj =  $.fn.zTree.init($("#orgSearchList"), searchSetting, treeData);
    showTreeObj.expandAll(true);
    searchTreeObj.expandAll(true);
    initMultiSelect();
  });
</script>
